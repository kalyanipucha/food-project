<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NGO Panel - FoodBridge</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      color: #263238;
    }
    header {
      background: #1B5E20;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 1.6rem; }
    nav a, #loginBtn, #signInBtn, #signOutBtn {
      color: white;
      text-decoration: none;
      margin-left: 1rem;
      cursor: pointer;
      font-weight: bold;
    }
    nav a:hover, #loginBtn:hover, #signInBtn:hover, #signOutBtn:hover { color: #FF7043; }
    #welcomeMsg { font-weight: bold; font-size: 1.2rem; margin-left: 1rem; }

    .container { max-width: 1000px; margin: 3rem auto; padding: 0 2rem; }
    h2 { text-align: center; color: #1B5E20; margin-bottom: 2rem; }

    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }
    th, td { padding: 12px 15px; text-align: left; }
    th { background: #1B5E20; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }

    button.claim-btn {
      background: #FF7043;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    button.claim-btn:hover { background: #e64a19; }
    button.claimed-btn {
      background: #888888;
      cursor: default;
    }

    img.food-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 8% auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .modal-content h3 { text-align: center; color: #1B5E20; margin-bottom: 20px; }
    .modal-content label { display:block; margin-bottom:6px; font-weight:600; }
    .modal-content input, .modal-content textarea {
      width:100%; padding:12px; margin-bottom:16px; border:1.5px solid #d1d5db; border-radius:12px; font-size:1rem;
    }
    .modal-content button {
      width:100%; padding:16px; background:#16a34a; border:none; border-radius:14px; color:white; font-weight:600; cursor:pointer;
    }
    .modal-content button:hover { background:#15803d; }
    .close-btn { float:right; font-size:1.5rem; cursor:pointer; }
    .success, .error { display:none; text-align:center; padding:12px; margin-top:10px; border-radius:10px; font-weight:600; }
    .success { background:#dcfce7; color:#166534; }
    .error { background:#fee2e2; color:#991b1b; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center;">
      <h1>FoodBridge - NGO Panel</h1>
      <div id="welcomeMsg"></div>
      <a id="loginBtn" href="ngo-login.html">Login</a>
      <a id="signInBtn" href="ngo-signup.html">Sign Up</a>
      <a id="signOutBtn" style="display:none;">Sign Out</a>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="donation-form.html">Donate</a>
      <a href="ngo-panel.html">NGO Panel</a>
      <a href="map.html">Map</a>
    </nav>
  </header>

  <div class="container">
    <h2>Available Donations</h2>
    <table id="donationTable">
      <thead>
        <tr>
          <th>Donor</th>
          <th>Food Type</th>
          <th>Quantity</th>
          <th>Location</th>
          <th>Emergency</th>
          <th>Image</th>
          <th>Claim</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Receiver Modal -->
  <div id="receiverModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3>üì¶ Receiver Info Form</h3>
      <form id="receiverForm">
        <label for="ngo_name">NGO Name</label>
        <input type="text" id="ngo_name" readonly />

        <label for="ngo_email">NGO Email</label>
        <input type="email" id="ngo_email" placeholder="Enter NGO email" required />

        <label for="receiver_name">Receiver Name</label>
        <input type="text" id="receiver_name" placeholder="Receiver full name" required />

        <label for="receiver_phone">Phone Number</label>
        <input type="tel" id="receiver_phone" placeholder="Receiver phone" required />

        <label for="receiver_id">ID Proof</label>
        <input type="text" id="receiver_id" placeholder="ID type & number" required />

        <label for="live_location">Current Location</label>
        <textarea id="live_location" rows="3" placeholder="Pickup location" required></textarea>

        <label for="delivery_time">Estimated Delivery Time</label>
        <input type="datetime-local" id="delivery_time" required />

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="2" placeholder="Any instructions"></textarea>

        <button type="submit">Submit Receiver Info</button>
      </form>
      <div class="success">‚úÖ Info submitted successfully!</div>
      <div class="error">‚ùå Error submitting info. Try again.</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://iehnndinuncsqzfhvfxa.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllaG5uZGludW5jc3F6Zmh2ZnhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3ODU1OTEsImV4cCI6MjA3MzM2MTU5MX0.iQ0NvE4Fhf4s3zXv-oizF3gxS2pRJlwdWKduuqdjgGA";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const tableBody = document.querySelector("#donationTable tbody");
    const welcomeDiv = document.getElementById("welcomeMsg");
    const loginBtn = document.getElementById("loginBtn");
    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");

    const ngoId = localStorage.getItem("ngo_id");
    const ngoName = localStorage.getItem("ngo_name");

    const modal = document.getElementById("receiverModal");
    const closeBtn = modal.querySelector(".close-btn");
    const receiverForm = document.getElementById("receiverForm");
    const successDiv = modal.querySelector(".success");
    const errorDiv = modal.querySelector(".error");

    // Header update
    if (ngoId) {
      welcomeDiv.innerText = `Welcome, ${ngoName}!`;
      loginBtn.style.display = "none";
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";
    }

    signOutBtn.addEventListener("click", () => {
      localStorage.removeItem("ngo_id");
      localStorage.removeItem("ngo_name");
      location.reload();
    });

    async function fetchDonations() {
      const { data, error } = await supabase
        .from("donations")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) { console.error(error); return; }

      tableBody.innerHTML = "";
      for (const donation of data) {
        const { data: claimedData } = await supabase
          .from("donation_claims")
          .select("*")
          .eq("donation_id", donation.id);

        if (claimedData.length > 0) continue;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${donation.donor_name}</td>
          <td>${donation.food_type}</td>
          <td>${donation.quantity}</td>
          <td>${donation.location}</td>
          <td>${donation.emergency_mode ? "Yes" : "No"}</td>
          <td>${donation.photo_url ? `<img src="${donation.photo_url}" class="food-img">` : "No Image"}</td>
          <td><button class="claim-btn">Claim</button></td>
        `;
        const claimBtn = row.querySelector(".claim-btn");

        if (!ngoId) {
          claimBtn.disabled = true;
          claimBtn.innerText = "Login to Claim";
          claimBtn.classList.add("claimed-btn");
        } else {
          claimBtn.addEventListener("click", () => openReceiverModal(donation.id, row));
        }

        tableBody.appendChild(row);
      }
    }

    async function openReceiverModal(donationId, tableRow) {
      modal.style.display = "block";
      document.getElementById("ngo_name").value = ngoName;

      receiverForm.onsubmit = async (e) => {
        e.preventDefault();

        const receiverInfo = {
          ngo_id: ngoId,
          ngo_name: document.getElementById("ngo_name").value,
          ngo_email: document.getElementById("ngo_email").value,
          receiver_name: document.getElementById("receiver_name").value,
          receiver_phone: document.getElementById("receiver_phone").value,
          receiver_id: document.getElementById("receiver_id").value,
          live_location: document.getElementById("live_location").value,
          delivery_time: document.getElementById("delivery_time").value,
          notes: document.getElementById("notes").value || null,
          donation_id: donationId,
          created_at: new Date().toISOString()
        };

        const { error } = await supabase.from("donation_receivers").insert([receiverInfo]);

        if (error) {
          console.error(error);
          successDiv.style.display = "none";
          errorDiv.style.display = "block";
        } else {
          errorDiv.style.display = "none";
          successDiv.style.display = "block";
          // Mark as claimed
          await supabase.from("donation_claims").insert([{ donation_id: donationId, ngo_id: ngoId }]);
          tableRow.remove();
          setTimeout(() => { modal.style.display = "none"; receiverForm.reset(); }, 1200);
        }
      };
    }

    closeBtn.onclick = () => { modal.style.display = "none"; receiverForm.reset(); };

    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };

    fetchDonations();
  </script>
</body>
</html>
